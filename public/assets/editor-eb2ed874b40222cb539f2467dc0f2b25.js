var editor=function(){function e(){if($("#zenpenbubble").length){lastRange=0,n();var e=document.createRange(),o=window.getSelection();o.removeAllRanges(),o.addRange(e),t()}}function t(){document.onkeyup=o,document.onmousedown=o,document.onmouseup=function(e){setTimeout(function(){o(e)},1)},window.addEventListener("resize",function(){i()});var e=!0;document.body.addEventListener("scroll",function(){return e?(e=!0,i(),setTimeout(function(){e=!0},250)):void 0})}function n(){v=document.querySelector(".content"),S=document.querySelector(".text-options"),x=S.querySelector(".options"),b=S.querySelector(".bold"),b.onclick=r,C=S.querySelector(".italic"),C.onclick=d,k=S.querySelector(".url"),k.onmousedown=f,L=S.querySelector(".url-input"),L.onblur=p,L.onkeydown=m}function o(e){var t=window.getSelection();return"url-input"===e.target.className||"undefined"!=typeof e.target.classList&&e.target.classList.contains("url")?(y=u(t.focusNode),void c()):null!=e.target.parentNode.classList&&e.target.parentNode.classList.contains("ui-inputs")?(y=u(t.focusNode),void c()):(t.isCollapsed===!0&&w===!1&&a(),t.isCollapsed===!1&&(y=u(t.focusNode),1==s(t.focusNode)&&(c(),i(),S.className="text-options active")),void(w=t.isCollapsed))}function i(){var e=window.getSelection(),t=e.getRangeAt(0),n=t.getBoundingClientRect();S.style.top=n.top-5+window.pageYOffset+"px",S.style.left=(n.left+n.right)/2+"px"}function c(){b.className=l(y,"B")?"bold active":"bold",C.className=l(y,"I")?"italic active":"italic",k.className=l(y,"A")?"url useicons active":"url useicons"}function a(){S.className="text-options fade",setTimeout(function(){"text-options fade"==S.className&&(S.className="text-options",S.style.top="-999px",S.style.left="-999px")},260)}function u(e){for(var t={};e.parentNode;)t[e.nodeName]=!0,e=e.parentNode,"A"===e.nodeName&&(t.url=e.getAttribute("href"));return t}function s(e){for(;e.parentNode;){if(void 0!==e.className&&e.className.indexOf("phrasable_on")>=0)return!0;e=e.parentNode}return!1}function l(e,t){return!!e[t]}function r(){document.execCommand("bold",!1)}function d(){document.execCommand("italic",!1)}function f(){"options"==x.className?(x.className="options url-mode",setTimeout(function(){var e=u(window.getSelection().focusNode);l(e,"A")?L.value=e.url:document.execCommand("createLink",!1,"/"),lastSelection=window.getSelection().getRangeAt(0),w=!1,L.focus()},100)):x.className="options"}function m(e){13===e.keyCode&&(e.preventDefault(),N(L.value),L.blur())}function p(){x.className="options",N(L.value),L.value="",y=u(window.getSelection().focusNode),c()}function N(e){g(),document.execCommand("unlink",!1),""!==e&&document.execCommand("createLink",!1,e)}function g(){window.getSelection().addRange(lastSelection)}var v,w,y,S,x,b,C,k,L;return{init:e}}();